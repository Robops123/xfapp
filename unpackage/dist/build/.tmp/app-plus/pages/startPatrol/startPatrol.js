(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/startPatrol/startPatrol"],{2010:function(t,e,n){"use strict";var o,a=function(){var t=this,e=t.$createElement;t._self._c},i=[];n.d(e,"b",function(){return a}),n.d(e,"c",function(){return i}),n.d(e,"a",function(){return o})},"2bc5":function(t,e,n){"use strict";var o=n("f885"),a=n.n(o);a.a},7043:function(t,e,n){"use strict";n.r(e);var o=n("2010"),a=n("a668");for(var i in a)"default"!==i&&function(t){n.d(e,t,function(){return a[t]})}(i);n("2bc5");var r,s=n("f0c5"),c=Object(s["a"])(a["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],r);e["default"]=c.exports},"965a":function(t,e,n){"use strict";(function(t){n("d53d"),n("921b");o(n("66fd"));var e=o(n("7043"));function o(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,n("6e42")["createPage"])},a668:function(t,e,n){"use strict";n.r(e);var o=n("aee1"),a=n.n(o);for(var i in o)"default"!==i&&function(t){n.d(e,t,function(){return o[t]})}(i);e["default"]=a.a},aee1:function(t,e,n){"use strict";(function(t,o){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var a,i=f(n("a34a")),r=n("2f62"),s=n("5153"),c=f(n("f40e")),u=f(n("d429")),l=n("bb60");function f(t){return t&&t.__esModule?t:{default:t}}function d(t,e,n,o,a,i,r){try{var s=t[i](r),c=s.value}catch(u){return void n(u)}s.done?e(c):Promise.resolve(c).then(o,a)}function g(t){return function(){var e=this,n=arguments;return new Promise(function(o,a){var i=t.apply(e,n);function r(t){d(i,o,a,r,s,"next",t)}function s(t){d(i,o,a,r,s,"throw",t)}r(void 0)})}}function m(t,e){return v(t)||p(t,e)||h()}function h(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function p(t,e){var n=[],o=!0,a=!1,i=void 0;try{for(var r,s=t[Symbol.iterator]();!(o=(r=s.next()).done);o=!0)if(n.push(r.value),e&&n.length===e)break}catch(c){a=!0,i=c}finally{try{o||null==s["return"]||s["return"]()}finally{if(a)throw i}}return n}function v(t){if(Array.isArray(t))return t}function x(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},o=Object.keys(n);"function"===typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),o.forEach(function(e){I(t,e,n[e])})}return t}function I(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var y=[["camera"],["album"],["camera","album"]],S=[["compressed"],["original"],["compressed","original"]],b=function(){return n.e("components/uni-icon/uni-icon").then(n.bind(null,"256b"))},L=function(){return n.e("components/uni-collapse/uni-collapse").then(n.bind(null,"09cc"))},P=function(){return n.e("components/uni-collapse-item/uni-collapse-item").then(n.bind(null,"5d0f"))},T={mixins:[s.nfc,l.Common],components:{UniIcons:b,uniCollapse:L,uniCollapseItem:P},onLoad:function(){this.checkHasBegin(),1==t.getStorageSync("scanway")&&(this.index=1,this.checkUfcOpen()),this.scanListener(),""!=t.getStorageSync("operation")?this.getRecordFromMemory():console.log(o("无记录"," at pages\\startPatrol\\startPatrol.vue:149"))},onHide:function(){},onShow:function(){var e=this;e.findTrouble(t.getStorageSync("activityId"),null,function(t){e.total=t.length,e.$forceUpdate()},function(){console.log(o("错误"," at pages\\startPatrol\\startPatrol.vue:169"))})},data:function(){var e;return e={form:{tenantId:t.getStorageSync("tenantId"),xgId:"",xgList:[],remark:"",startTime:"",endTime:""},xgItems:[],errmsg:"",formcontent:"",ClickedIndex:null,nfcEnable:!1,scanned:!1,index:0,total:0,array:["二维码","NFC"],order_no:"",select_item:"",price_type:"common_price",product_name:"",product_image1:"",price:0,price1:0,price2:0,price3:0,activeIndex:-1,desc:""},I(e,"index",0),I(e,"items",[]),I(e,"indexSex",0),I(e,"indexOld",40),I(e,"seller",""),I(e,"seller_id",0),I(e,"consultant",""),I(e,"consultant_id",0),I(e,"consultant_phone",""),I(e,"buyer",""),I(e,"uploaded",0),I(e,"buyer_phone",""),I(e,"buyer_collector",""),I(e,"remark",""),I(e,"imageList",[]),I(e,"sourceTypeIndex",2),I(e,"sizeTypeIndex",2),I(e,"countIndex",8),I(e,"count",[1,2,3,4,5,6,7,8,9]),I(e,"boxList",[{inspectionItemId:"1",inspectionItemName:"aaa"},{inspectionItemId:"2",inspectionItemName:"bbb"},{inspectionItemId:"3",inspectionItemName:"ccc"},{inspectionItemId:"4",inspectionItemName:"ddd"}]),e},computed:x({},(0,r.mapState)(["userRole"])),methods:(a={scan:function(){1==this.index?this.test_nfc():this.qrscanner()},scanListener:function(){var e=this;this.$on("getv",function(n){if(e.scanned=!0,""==e.form.xgList)e.test(n,"nfc",function(o){e.form.xgList.push({id:o.pointId,total:o.total,pointId:n,pointName:o.pointName,details:[]}),e.xgItems.push(o.itemTypeList),t.setStorageSync("operation",e.form),t.setStorageSync("xgItems",e.xgItems),e.todetail(e.form.xgList.length-1)});else{var o="";e.form.xgList.forEach(function(t,a){if(t.pointId.toString()===n.toString())throw e.todetail(a),e.$off("getv"),setTimeout(function(){e.scanListener()},200),Error();o=n}),e.test(o,"nfc",function(o){e.form.xgList.push({id:o.pointId,total:o.total,pointId:n,pointName:o.pointName,details:[]}),e.xgItems.push(o.itemTypeList),t.setStorageSync("operation",e.form),t.setStorageSync("xgItems",e.xgItems),e.todetail(e.form.xgList.length-1)})}e.$off("getv"),setTimeout(function(){e.scanListener()},200)})},checkboxChange:function(t){this.select_item=t.detail.value},loadCollectTypes:function(){var t=this;this.$api.getCategory("collector_type",0).then(function(e){var n=m(e,2),o=n[0],a=n[1];if(null==o){var i=a.data;for(var r in i)t.items.push({value:r,name:i[r]})}})},bindSexChange:function(t){this.indexSex=t.target.value},bindOldChange:function(t){this.indexOld=t.target.value},wxscan:function(t){var e=this;wx.config(t),wx.ready(function(){wx.scanQRCode({needResult:1,scanType:["qrCode","barCode"],success:function(t){var n=t.resultStr,o=n.split(",")[1];if(0==e.buyer_collector.length)e.buyer_collector=o;else{var a=e.buyer_collector.split(",");a.includes(o)||(e.buyer_collector+=","+o)}}})})},switchActive:function(t){var e=this;this.activeIndex=t,setTimeout(function(){e.activeIndex=-1},500);var n={debug:!1,json:!0,apis:"scanQRCode",url:window.location.href.split("#")[0]},o=JSON.parse(sessionStorage.getItem("userToken"));this.$api.getJsSDKConfig(n,o).then(function(t){var n=m(t,2),o=n[0],a=n[1];null==o&&e.wxscan(a.data)})},switchChange:function(t){this.price==this.price1?("representative"==this.userRole?this.price=this.price2:this.price=this.price3,this.price_type="special_price"):(this.price_type="common_price",this.price=this.price1)},sourceTypeChange:function(t){this.sourceTypeIndex=t.target.value},sizeTypeChange:function(t){this.sizeTypeIndex=t.target.value},countChange:function(t){this.countIndex=t.target.value},chooseImage:function(){var e=g(i.default.mark(function e(){var n,o=this;return i.default.wrap(function(e){while(1)switch(e.prev=e.next){case 0:if(9!==this.imageList.length){e.next=6;break}return e.next=3,this.isFullImg();case 3:if(n=e.sent,n){e.next=6;break}return e.abrupt("return");case 6:t.chooseImage({sourceType:y[this.sourceTypeIndex],sizeType:S[this.sizeTypeIndex],count:this.imageList.length+this.count[this.countIndex]>9?9-this.imageList.length:this.count[this.countIndex],success:function(t){o.imageList=o.imageList.concat(t.tempFilePaths[0])}});case 7:case"end":return e.stop()}},e,this)}));function n(){return e.apply(this,arguments)}return n}(),isFullImg:function(){var e=this;return new Promise(function(n){t.showModal({content:"是否清空现有图片？",success:function(t){t.confirm?(e.imageList=[],n(!0)):n(!1)},fail:function(){n(!1)}})})},previewImage:function(e){var n=e.target.dataset.src;t.previewImage({current:n,urls:this.imageList})},report:function(e,n){var a=this;t.$on("submitResult",function(e){console.log(o(e," at pages\\startPatrol\\startPatrol.vue:433")),a.form.xgList[e.index].result=e.result,t.setStorageSync("operation",a.form),t.setStorageSync("xgItems",a.xgItems),t.$off("submitResult")}),t.navigateTo({url:"/pages/startPatrol/report?params="+JSON.stringify(e)+"&index="+n})},checkUfcOpen:function(){var t=plus.android.runtimeMainActivity(),e=plus.android.importClass("android.nfc.NfcAdapter"),n=e.getDefaultAdapter(t);n.isEnabled()?(this.nfcEnable=!0,this.scan()):this.nfcEnable=!1},qrscanner:function(){var e=this;t.scanCode({onlyFromCamera:!0,success:function(n){if(""==e.form.xgList)e.test(n.result,"qrcode",function(o){e.form.xgList.push({id:o.pointId,pointId:n.result,total:o.total,pointName:o.pointName,details:[]}),e.xgItems.push(o.itemTypeList),t.setStorageSync("operation",e.form),t.setStorageSync("xgItems",e.xgItems),e.todetail(e.form.xgList.length-1)});else{var o="";e.form.xgList.forEach(function(t,a){if(t.pointId.toString()===n.result.toString())throw o="",e.todetail(a),Error();o=n.result}),""!=o&&e.test(n.result,"qrcode",function(o){e.form.xgList.push({id:o.pointId,pointId:n.result,total:o.total,pointName:o.pointName,details:[]}),e.xgItems.push(o.itemTypeList),t.setStorageSync("operation",e.form),t.setStorageSync("xgItems",e.xgItems),e.todetail(e.form.xgList.length-1)})}},fail:function(t){console.log(o(t," at pages\\startPatrol\\startPatrol.vue:522"))}})},calcPass:function(){},findItems:function(e,n){t.getStorageSync("xjdList");var o="";return this.test(e,n,function(t){o=t}),o},getCbIndex:function(t,e){console.log(o(t," at pages\\startPatrol\\startPatrol.vue:556")),console.log(o(e," at pages\\startPatrol\\startPatrol.vue:557"))},getDate:function(t){var e=new Date,n=e.getFullYear(),o=e.getMonth()+1,a=e.getDate(),i=e.getHours(),r=e.getMinutes(),s=e.getSeconds();return"start"===t?n-=60:"end"===t&&(n+=2),o=o>9?o:"0"+o,a=a>9?a:"0"+a,i=i>9?i:"0"+i,r=r>9?r:"0"+r,s=s>9?s:"0"+s,"".concat(n,"-").concat(o,"-").concat(a," ").concat(i,":").concat(r,":").concat(s)}},I(a,"checkboxChange",function(t){var e=t.detail.value;this.form.xgList[this.ClickedIndex].itemId=e}),I(a,"bindPickerChange",function(t){this.index=t.target.value}),I(a,"change",function(t){this.ClickedIndex=parseInt(t)}),I(a,"save",function(){u.default.showLoading(),t.setStorageSync("xgItems",this.xgItems),t.setStorageSync("operation",this.form),u.default.hideLoading(),u.default.showToast("当前记录保存成功")}),I(a,"checkHasBegin",function(){var e=t.getStorageSync("activityId");if(""==e){var n=this.guid();this.form.startTime=this.getDate({format:!0}),t.setStorageSync("activityId",n),this.form.xgId=n,t.setStorageSync("operation",this.form),console.log(o(this.form.xgId," at pages\\startPatrol\\startPatrol.vue:615"))}else this.form.xgId=t.getStorageSync("activityId"),console.log(o(this.form.xgId," at pages\\startPatrol\\startPatrol.vue:619"))}),I(a,"getRecordFromMemory",function(){var e=this;if(this.form=t.getStorageSync("operation"),1==this.form.finish)return u.default.showToast("请在巡检记录中提交上次记录"),void t.navigateBack({delta:1});""!=t.getStorageSync("xgItems")&&(this.xgItems=t.getStorageSync("xgItems"),this.form.xgList.forEach(function(t,n){0==t.itemId.length?e.xgItems[n].forEach(function(t,e){t.checked=!1}):t.itemId.forEach(function(t,o){e.xgItems[n].forEach(function(e,n){e.inspectionItemId==t||null==e.inspectionItemId&&""==t?e.checked=!0:e.checked=!1})})}))}),I(a,"clear",function(){t.clearStorageSync()}),I(a,"toTroubleList",function(){this.total&&t.navigateTo({url:"/pages/hidTrouble/hidTroubleList?editable=true"})}),I(a,"todetail",function(e){var n=this,o=0;t.$on("saveComplete",function(e){n.xgItems=t.getStorageSync("xgItems");var a=[];n.xgItems[e].forEach(function(t){t.itemList.forEach(function(t,e){0==t.value&&o++,a.push({id:t.itemId,value:t.value})})}),n.form.xgList[e].details=a,n.form.xgList[e].saved=!0,n.form.xgList[e].total=a.length,n.form.xgList[e].passed=o,n.form.xgList[e].passedPercentage=n.toPercent(o/n.form.xgList[e].total),t.setStorageSync("operation",n.form),t.$off("saveComplete")}),t.navigateTo({url:"/pages/startPatrol/patrolDetail?index="+e+"&name="+n.form.xgList[e].pointName})}),I(a,"toPercent",function(t){var e=Number(100*t).toFixed(1);return e+="%",e}),I(a,"submit",function(){console.log(o(this.form," at pages\\startPatrol\\startPatrol.vue:699"))}),I(a,"submitxg",function(){var e=this;t.showModal({title:"确定提交本次巡检内容",content:"提交后无法更改",cancelText:"我再想想",confirmText:"确定提交",success:function(n){if(e.formcontent=JSON.stringify(e.form),n.confirm){var a=!0;if(e.form.xgList.forEach(function(t){t.saved||(console.log(o("没保存"," at pages\\startPatrol\\startPatrol.vue:714")),a=!1)}),!a)return u.default.hideLoading(),void u.default.showToast("请先确认巡检项");e.form.endTime=e.getDate({format:!0}),e.networkEnable()?(console.log(o("enable"," at pages\\startPatrol\\startPatrol.vue:727")),u.default.showLoading(),e.submitTrouble()):(e.form.finish=1,t.setStorageSync("operation",e.form),u.default.showToast("网络不可用"),setTimeout(function(){t.navigateBack({delta:1})},1e3))}else n.cancel&&console.log(o("用户点击取消"," at pages\\startPatrol\\startPatrol.vue:743"))}})}),I(a,"submitForm",function(){var e=this;console.log(o(this.form," at pages\\startPatrol\\startPatrol.vue:773")),c.default.apiPost("/check/add/",e.form).then(function(n){e.errmsg=JSON.stringify(n),200==n.code?(u.default.hideLoading(),u.default.showToast("提交成功"),t.removeStorageSync("operation"),t.removeStorageSync("xgItems"),t.removeStorageSync("activityId"),setTimeout(function(){t.navigateBack({delta:1})},1e3)):(u.default.hideLoading(),u.default.showToast("提交失败"))})}),I(a,"submitTrouble",function(){var t=this;this.findTrouble(this.form.xgId,null,function(e){console.log(o(e," at pages\\startPatrol\\startPatrol.vue:796")),e&&e.length>0?e.forEach(function(e){if(e.pictures){var n=[];n=e.pictures.split(","),t.uploadImg(e,n,0,"")}else t.submitHazard(e)}):t.submitForm()},function(){console.log(o("err"," at pages\\startPatrol\\startPatrol.vue:815")),t.submitForm()})}),I(a,"submitHazard",function(t){var e=this;c.default.apiPost("/hazard/add/",t).then(function(t){200==t.code?(e.uploaded++,e.uploaded==e.total&&e.submitForm()):(u.default.hideLoading(),u.default.showToast("提交失败"))}).catch(function(t){u.default.hideLoading(),u.default.showToast("请检查网络")})}),I(a,"uploadImg",function(e,n,o,a){var i=this;t.uploadFile({url:c.default.baseURL+"/hazard/upload",filePath:n[o],name:"file",header:{Accept:"application/json",Authorization:"Bearer "+t.getStorageSync("Authorization")},success:function(t){var r=JSON.parse(t.data);200==r.code?o<n.length-1?(o++,a+=r.data+",",i.uploadImg(e,n,o,a)):o==n.length-1&&(a+=r.data,e.pictures=a,i.submitHazard(e)):u.default.showToast("图片上传失败")},fail:function(t){u.default.showToast("请检查网络连接")}})}),a),watch:{index:function(e,n){t.setStorageSync("scanway",e),1==e?this.checkUfcOpen():0==e&&(this.nfcEnable=!1,this.$off("getv"))}}};e.default=T}).call(this,n("6e42")["default"],n("0de9")["default"])},f885:function(t,e,n){}},[["965a","common/runtime","common/vendor"]]]);